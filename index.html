<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <link rel="stylesheet" href="font/meslo.css"/>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/diff/dist/diff.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/github.min.css" />
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui-slim.min.js"></script>
        <link rel="stylesheet" data-name="vs/editor/editor.main"
            href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.0/min/vs/editor/editor.main.min.css"/>
        <script>
            var require = { paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.0/min/vs' } };
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.0/min/vs/loader.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.0/min/vs/editor/editor.main.nls.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.0/min/vs/editor/editor.main.min.js"></script>
        <style>
            .d2h-file-header {
                display: none;
            }
            .d2h-diff-table {
                font-family: "meslo";
                font-size: 16px
            }
        </style>
        <script>
            const knyteSpaceApi = {
                bootloaderKnyteId: '2ac04735-106f-4179-aa49-bdbe5e740d77',
                viewportElement: undefined,
                initialKnytes: undefined,
                promptOnExit: () => {return undefined;}
            };

            async function onLoad()
            {
                console.info('welcome to knyte space');
                
                // init core api
                {
                    // resolve access
                    const accessTokenPath = 'knyte.space access-token';
                    knyteSpaceApi.localAccessToken = localStorage.getItem(accessTokenPath);
                    if (knyteSpaceApi.localAccessToken === null)
                    {
                        const newAccessToken = prompt('Enter your system access token:', '');
                        if (newAccessToken === null)
                            throw Error('No access token given');
                        localStorage.setItem(accessTokenPath, newAccessToken);
                        setTimeout(() => {location.reload();}, 200);
                        return;
                    }
                    // resolve viewport
                    knyteSpaceApi.viewportElement = document.getElementById('viewport');
                    // initialise knytes
                    const response = await fetch(
                        'https://knyte-space.herokuapp.com/knytes', 
                        {headers: {accesstoken: knyteSpaceApi.localAccessToken}});
                    if (response.status === 200) // Success
                    {
                        const json = await response.json();
                        knyteSpaceApi.initialKnytes = json.result;
                        // initialise warnigs on exit
                        window.onbeforeunload = (event) => {
                            return knyteSpaceApi.promptOnExit();
                        };
                    }
                    else if (response.status === 401) // Unauthorized
                    {
                        localStorage.removeItem(accessTokenPath);
                        return;
                    }
                    console.info('\tapi initialised');
                }

                // boot the system
                {
                    console.info('\tbooting started');
                    // get bootloader knyte
                    const response = await fetch(
                        'https://knyte-space.herokuapp.com/knyte/knyteId=' + knyteSpaceApi.bootloaderKnyteId,
                        {headers: {accesstoken: knyteSpaceApi.localAccessToken}});
                    const json = await response.json();
                    const bootloaderKnyte = json.result[0];
                    // run bootloader code
                    const {content} = bootloaderKnyte;
                    try
                    {
                        const bootloaderFunction = new Function(content);
                        bootloaderFunction();
                    }
                    catch(e)
                    {
                        throw e;
                    }
                }
            }
        </script>
    </head>
    <body onload="onLoad()">
        <div id="viewport"></div>
    </body>
</html>