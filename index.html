<!DOCTYPE html>
<html>
    <head>
        <style>
            @font-face {
                font-family: "meslo";
                src: url("font/MesloLGM-Italic.ttf") format("truetype");
                font-weight: normal;
                font-style: italic;
            }
            @font-face {
                font-family: "meslo";
                src: url("font/MesloLGM-Regular.ttf") format("truetype");
                font-weight: normal;
                font-style: normal;
            }
            @font-face {
                font-family: "meslo";
                src: url("font/MesloLGM-Bold.ttf") format("truetype");
                font-weight: bold;
                font-style: normal;
            }
            @font-face {
                font-family: "meslo";
                src: url("font/MesloLGM-BoldItalic.ttf") format("truetype");
                font-weight: bold;
                font-style: italic;
            }
        </style>
        <style>
            body {
                font-family: meslo;
                margin: 2em;
            }
            div {
                margin: 0.5em;
                padding: 0.5em;
            }
            pre {
                font-family: meslo;
                display: inline-block;
            }
            button {
                font-family: meslo;
                margin: 0.3em;
            }
            .runBlockReady {
                border: 2px solid black;
            }
            .runBlockError {
                border: 2px solid red;
            }
            .content {
                border: 1px solid gray;
                margin: 0.5em;
                padding: 0.5em;
            }
        </style>
        <script>
            const knyteMap = {};
            const originToLinkMap = {};
            const terminationToLinkMap = {};

            function handleRunClick(e)
            {
                function runBlock(knyteId)
                {
                    const {content} = knyteMap[knyteId];
                    const knyteElement = document.getElementById('knoxel-' + knyteId);
                    // run knyte content as a peace of js code
                    try
                    {
                        const knyteFunction = new Function(content);
                        knyteFunction();
                        knyteElement.className = 'runBlockReady';
                    }
                    catch(e)
                    {
                        knyteElement.className = 'runBlockError';
                        throw e;
                    }
                    // check outgoing links to run termination knytes
                    const knyteIds = originToLinkMap[knyteId];
                    if (knyteIds)
                        for (var i = 0; i < knyteIds.length; ++i)
                        {
                            const terminationKnyte = knyteMap[knyteIds[i]];
                            if (terminationKnyte)
                            {
                                const terminationId = terminationKnyte.termination_id;
                                if (terminationId)
                                    runBlock(terminationId);
                            }
                        }
                }

                const {knyteId} = e.target.dataset;
                runBlock(knyteId);
            }

            function handleIdClick(e)
            {
                const {knyteId} = e.target.dataset;
                alert(knyteId);
            }

            async function onLoad()
            {
                const response = await fetch('https://knyte-space.herokuapp.com/knytes');
                const json = await response.json();
                const knytes = json.result;
                const knyteList = document.getElementById('knyteList');
                // build knyte maps
                for (var i = 0; i < knytes.length; ++i)
                {
                    const knyte = knytes[i];
                    knyteMap[knyte.knyte_id] = knyte;
                    if (knyte.origin_id)
                    {
                        if (!originToLinkMap[knyte.origin_id])
                            originToLinkMap[knyte.origin_id] = [];
                        originToLinkMap[knyte.origin_id].push(knyte.knyte_id);
                    }
                    if (knyte.termination_id)
                    {
                        if (!terminationToLinkMap[knyte.termination_id])
                            terminationToLinkMap[knyte.termination_id] = [];
                        terminationToLinkMap[knyte.termination_id].push(knyte.knyte_id);
                    }
                }
                // show knyte content
                for (var i = 0; i < knytes.length; ++i)
                {
                    const knyte = knytes[i];
                    const knyteElement = document.createElement('div');
                    const originElement = document.createElement('pre');
                    const contentElement = document.createElement('pre');
                    const terminationElement = document.createElement('pre');
                    const idElement = document.createElement('button');
                    const runElement = document.createElement('button');
                    knyteElement.id = 'knoxel-' + knyte.knyte_id;
                    knyteElement.className = 'runBlockReady';
                    if (knyte.origin_id)
                        originElement.textContent = knyteMap[knyte.origin_id].content;
                    contentElement.textContent = knyte.content;
                    contentElement.className = 'content';
                    if (knyte.termination_id)
                        terminationElement.textContent = knyteMap[knyte.termination_id].content;
                    idElement.textContent = 'id';
                    idElement.dataset.knyteId = knyte.knyte_id;
                    idElement.onclick = handleIdClick;
                    runElement.textContent = 'run';
                    runElement.dataset.knyteId = knyte.knyte_id;
                    runElement.onclick = handleRunClick;
                    knyteElement.appendChild(originElement);
                    knyteElement.appendChild(contentElement);
                    knyteElement.appendChild(terminationElement);
                    knyteElement.appendChild(idElement);
                    knyteElement.appendChild(runElement);
                    knyteList.appendChild(knyteElement);
                }
            }
        </script>
    </head>
    <body onload="onLoad()">
        <div id="knyteList"></div>
    </body>
</html>